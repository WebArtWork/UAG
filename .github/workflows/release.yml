name: Release

on:
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  might_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Release Variables
        id: vars
        uses: ignite/cli/actions/release/vars@main

      - name: Run Go unit tests
        if: ${{ steps.vars.outputs.should_release == 'true' }}
        run: go test ./...
        env:
          GOFLAGS: "-buildvcs=false"

      - name: Issue Release Assets
        uses: ignite/cli/actions/cli@main
        if: ${{ steps.vars.outputs.should_release == 'true' }}
        with:
          args: >
            chain build --release
            --release.prefix ${{ steps.vars.outputs.tarball_prefix }}
            -t linux:amd64
            -t darwin:amd64
            -t darwin:arm64
            -t windows:amd64
            -y
        env:
          DO_NOT_TRACK: 1
          GOFLAGS: "-buildvcs=false"

      - name: Normalize Windows release artifact (flat zip + uag.exe)
        if: ${{ steps.vars.outputs.should_release == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          WIN_TGZ="$(ls -1 release/*windows_amd64.tar.gz 2>/dev/null | head -n 1 || true)"
          if [[ -z "${WIN_TGZ}" ]]; then
            echo "No windows_amd64 tarball found in release/, skip"
            exit 0
          fi

          EXTRACT_DIR="$(mktemp -d)"
          tar -xzf "$WIN_TGZ" -C "$EXTRACT_DIR"

          BIN_PATH="$(find "$EXTRACT_DIR" -type f \( -name 'uag' -o -name 'uag.exe' \) | head -n 1 || true)"
          if [[ -z "${BIN_PATH}" ]]; then
            echo "Windows binary not found inside extracted archive"
            find "$EXTRACT_DIR" -maxdepth 5 -type f | head -n 200
            exit 1
          fi

          STAGE_DIR="$(mktemp -d)"
          cp "$BIN_PATH" "$STAGE_DIR/uag.exe"

          ZIP_OUT="${WIN_TGZ%.tar.gz}.zip"
          (cd "$STAGE_DIR" && zip -9 -q "$OLDPWD/$ZIP_OUT" uag.exe)

          rm -f "$WIN_TGZ"
          (cd release && rm -f release_checksum && sha256sum * > release_checksum)

          rm -rf "$EXTRACT_DIR" "$STAGE_DIR"

      - name: Delete the "latest" Release
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        if: ${{ steps.vars.outputs.is_release_type_latest == 'true' }}
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish the Release
        uses: softprops/action-gh-release@v2
        if: ${{ steps.vars.outputs.should_release == 'true' }}
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.vars.outputs.tag_name }}
          files: release/**
          prerelease: ${{ steps.vars.outputs.is_release_type_latest == 'true' }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
